<section class="servicios-peo">
  <header class="encabezado">
    <div>
      <h2>Catálogo y moderación de servicios</h2>
      <p>
        Aprueba o rechaza los tipos de servicio propuestos por proveedores y crea tipos base que
        queden activos al instante.
      </p>
    </div>
    <button type="button" (click)="cargarCatalogo(); cargarPendientes()" class="btn-recargar">
      <i class="bi bi-arrow-repeat"></i>
      Actualizar
    </button>
  </header>

  <div class="alerta" *ngIf="error">{{ error }}</div>
  <div class="exito" *ngIf="mensaje">{{ mensaje }}</div>

  <div class="paneles">
    <div class="panel">
      <div class="panel-cabecera">
        <h3>Crear tipo de servicio (admin)</h3>
        <p>Se publica como ACTIVO para que los proveedores creen sus ofertas.</p>
      </div>
      <form class="formulario" (ngSubmit)="registrarTipo()">
        <label>
          Nombre
          <input type="text" [(ngModel)]="nuevoTipo.nombre" name="nombre" required placeholder="Ej. Decoración" />
        </label>
        <label>
          Descripción
          <textarea
            rows="3"
            [(ngModel)]="nuevoTipo.descripcion"
            name="descripcion"
            placeholder="Breve detalle de qué abarca este servicio"
          ></textarea>
        </label>
        <div class="grupo-eventos">
          <p>Eventos aplicables</p>
          <div class="lista-check">
            <label class="check" *ngFor="let ev of eventos">
              <input
                type="checkbox"
                [checked]="ev.idEvento != null && eventosSeleccionados.has(ev.idEvento)"
                (change)="toggleEvento(ev.idEvento, eventosSeleccionados)"
              />
              <span>{{ ev.nombreEvento }}</span>
            </label>
            <label class="check">
              <input type="checkbox" [checked]="eventos.length > 0 && eventosSeleccionados.size === eventos.length" (change)="seleccionarTodos()" />
              <span>Todos</span>
            </label>
          </div>
        </div>
        <button class="btn-primario" type="submit">Publicar tipo</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-cabecera">
        <h3>Cola de tipos propuestos</h3>
        <p>Revisa y responde a los tipos que solicitaron los proveedores.</p>
      </div>
      <div *ngIf="cargandoPendientes" class="estado">Cargando propuestas...</div>
      <div *ngIf="!cargandoPendientes && !pendientes.length" class="estado">No hay propuestas pendientes.</div>

      <div class="card-pendiente" *ngFor="let cat of pendientes">
        <div class="card-info">
          <div>
            <p class="nombre">{{ cat.nombre }}</p>
            <p class="descripcion" *ngIf="cat.descripcion">{{ cat.descripcion }}</p>
            <small>Propuesto por {{ cat.creadoPor === 'PROVEEDOR' ? 'Proveedor' : 'Admin' }}</small>
          </div>
          <span class="badge badge-aviso">Pendiente</span>
        </div>
        <label class="motivo">
          Motivo de rechazo
          <textarea
            rows="2"
            [(ngModel)]="motivosRechazo[cat.idCatalogo]"
            name="motivo-{{ cat.idCatalogo }}"
            placeholder="Explica qué se debe corregir"
          ></textarea>
        </label>
        <div class="acciones">
          <button type="button" class="btn-secundario" (click)="rechazar(cat)">
            <i class="bi bi-x-circle"></i>
            Rechazar
          </button>
          <button type="button" class="btn-primario" (click)="aprobar(cat)">
            <i class="bi bi-check-circle"></i>
            Aprobar y activar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel listado">
    <div class="panel-cabecera">
      <div>
        <h3>Catálogo de tipos de servicio</h3>
        <p>Estados y origen de cada tipo disponible.</p>
      </div>
      <div class="filtro">
        <label>
          Estado
          <select [(ngModel)]="filtroEstado" name="filtro" (change)="cargarCatalogo()">
            <option value="TODOS">Todos</option>
            <option value="ACTIVO">Activos</option>
            <option value="PENDIENTE">Pendientes</option>
            <option value="RECHAZADO">Rechazados</option>
          </select>
        </label>
      </div>
    </div>

    <div *ngIf="cargandoCatalogo" class="estado">Cargando catálogo...</div>
    <div *ngIf="!cargandoCatalogo && !catalogo.length" class="estado">No hay registros.</div>

    <table *ngIf="!cargandoCatalogo && catalogo.length" class="tabla-servicios">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Creado por</th>
          <th>Última revisión</th>
          <th>Motivo rechazo</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cat of catalogo">
          <td>
            <strong>{{ cat.nombre }}</strong>
            <div class="descripcion" *ngIf="cat.descripcion">{{ cat.descripcion }}</div>
          </td>
          <td><span class="badge" [ngClass]="badgeClase(cat.estado)">{{ cat.estado }}</span></td>
          <td>{{ cat.creadoPor }}</td>
          <td>{{ cat.fechaRevision ? (cat.fechaRevision | date: 'short') : '-' }}</td>
          <td>
            <span *ngIf="cat.motivoRechazo; else sinMotivo">{{ cat.motivoRechazo }}</span>
            <ng-template #sinMotivo>-</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
