<div class="cliente-page">
  <header class="encabezado">
    <div>
      <p class="texto-sutil">Cliente</p>
      <h3>Hola, {{ nombre }}</h3>
      <p class="texto-sutil">Elige los servicios ideales para tu {{ tipoEventoLabel || 'evento' }}</p>
    </div>
    <div class="carrito-info" (click)="irAReservas()">
      <div class="carrito-icono">
        <i class="bi bi-cart3"></i>
      </div>
      <div>
        <p class="texto-sutil">Servicios seleccionados</p>
        <strong class="carrito-contador">{{ conteoVisibleCarrito }}</strong>
        <p class="texto-sutil" *ngIf="numeroReservaActual">Reserva N° {{ numeroReservaActual }}</p>
      </div>
    </div>
  </header>

  <section class="layout">
    <aside class="filtros">
      <div class="filtro">
        <div class="filtro-titulo">
          <h4>Eventos</h4>
          <button class="link" (click)="limpiarGrupo(selectedEventos)">Limpiar</button>
        </div>
        <div class="lista-check">
          <label class="check" *ngFor="let e of eventos">
            <input
              type="checkbox"
              [checked]="selectedEventos.has(normalizarEvento(e))"
              (change)="toggleSeleccion(e, selectedEventos)"
            />
            <span>{{ e }}</span>
          </label>
        </div>
      </div>

      <div class="filtro">
        <div class="filtro-titulo">
          <h4>Proveedores</h4>
          <button class="link" (click)="limpiarGrupo(selectedProveedores)">Limpiar</button>
        </div>
        <div class="lista-check">
          <label class="check" *ngFor="let prov of listadoProveedores">
            <input type="checkbox" [checked]="selectedProveedores.has(prov.toLowerCase())" (change)="toggleSeleccion(prov, selectedProveedores)" />
            <span>{{ prov }}</span>
          </label>
        </div>
      </div>

      <div class="filtro">
        <div class="filtro-titulo">
          <h4>Servicios</h4>
        </div>
        <div class="chips" *ngIf="listadoServicios.length; else sinServicios">
          <span class="chip" *ngFor="let srv of listadoServicios">{{ srv }}</span>
        </div>
      </div>

      <div class="filtro">
        <div class="filtro-titulo">
          <h4>Opciones de servicio</h4>
        </div>
        <div *ngIf="!cargandoOpciones; else cargandoOps" class="chips">
          <span class="chip" *ngFor="let op of listadoOpciones">{{ op }}</span>
          <p class="texto-sutil" *ngIf="!listadoOpciones.length">Selecciona proveedores para ver sus opciones.</p>
        </div>
        <ng-template #cargandoOps>
          <p class="texto-sutil">Cargando opciones...</p>
        </ng-template>
      </div>
      <ng-template #sinServicios>
        <p class="texto-sutil">Selecciona proveedores para ver sus servicios disponibles.</p>
      </ng-template>
    </aside>

    <section class="contenido">
      <div class="buscador">
        <input type="text" placeholder="Busca por proveedor o servicio" [(ngModel)]="busquedaProveedor" (input)="aplicarFiltros()" />
        <span class="resultados">{{ proveedoresFiltrados.length }} resultados</span>
      </div>

      <div class="estado" *ngIf="cargando">Cargando servicios...</div>
      <div class="estado error" *ngIf="!cargando && error">{{ error }}</div>
      <div class="estado" *ngIf="!cargando && !error && !proveedoresFiltrados.length">
        No encontramos servicios con los filtros seleccionados.
      </div>

      <div class="grid" *ngIf="!cargando && !error">
        <article class="card" *ngFor="let p of proveedoresFiltrados">
          <div class="card-header enhanced">
            <div class="logo-proveedor" [class.con-imagen]="logoProveedor(p)">
              <img
                *ngIf="logoProveedor(p)"
                [src]="logoProveedor(p)"
                alt="Logo de {{ p.proveedor.nombreEmpresa || p.proveedor.nombre }}"
              />
              <span *ngIf="!logoProveedor(p)">{{ inicialProveedor(p) }}</span>
            </div>
            <div class="info-principal">
              <p class="texto-sutil etiqueta">Proveedor</p>
              <h5>
                <img
                  *ngIf="logoProveedor(p)"
                  class="logo-mini"
                  [src]="logoProveedor(p)"
                  alt="Logo de {{ p.proveedor.nombreEmpresa || p.proveedor.nombre }}"
                />
                {{ p.proveedor.nombreEmpresa || p.proveedor.nombre }}
              </h5>
              <p class="texto-sutil ubicacion" *ngIf="p.proveedor.direccion">
                <i class="bi bi-geo-alt"></i>
                <span>{{ p.proveedor.direccion }}</span>
              </p>
              <div class="etiquetas-servicio">
                <span class="etiqueta">{{ p.catalogoServicio.nombre }}</span>
                <span class="chip suave" *ngIf="opcionesPorProveedor[p.idProveedorServicio]?.length">
                  {{ opcionesPorProveedor[p.idProveedorServicio].length }} opciones activas
                </span>
              </div>
            </div>
            <div class="sello-servicio">
              <span>{{ p.nombrePublico }}</span>
            </div>
          </div>

          <div class="card-img sin-foto">
            <span class="inicial-servicio">{{ p.nombrePublico.charAt(0) || 'S' }}</span>
          </div>

          <div class="card-body">
            <p class="texto-sutil descripcion">{{ p.descripcionGeneral || 'Servicio sin descripción.' }}</p>

            <div class="datos-contacto">
              <div class="dato">
                <i class="bi bi-telephone"></i>
                <span>{{ p.proveedor.usuario?.celular || 'Sin teléfono' }}</span>
              </div>
              <div class="dato">
                <i class="bi bi-envelope"></i>
                <span>{{ p.proveedor.usuario?.email || 'Sin correo' }}</span>
              </div>
            </div>

            <button class="btn-primario" (click)="verServicios(p)">Ver servicios</button>
          </div>
        </article>
      </div>
    </section>
  </section>

  <div class="modal-backdrop" *ngIf="modalVisible" (click)="cerrarModal()"></div>
  <div class="modal" *ngIf="modalVisible">
    <div class="modal-header">
      <div>
        <p class="texto-sutil">Servicios</p>
        <h4>{{ proveedorSeleccionado?.nombrePublico }}</h4>
        <p class="texto-sutil">Selecciona las opciones y agenda tu fecha</p>
      </div>
      <button class="btn-secundario" (click)="cerrarModal()">Cerrar</button>
    </div>

    <div class="modal-body" *ngIf="proveedorSeleccionado">
      <div class="opcion" *ngFor="let o of opciones">
        <label class="opcion-contenido">
          <input type="checkbox" [ngModel]="seleccion[o.idOpcion]" (ngModelChange)="alternarOpcion(o, $event)" />
          <div class="opcion-media">
            <img [src]="urlImagenOpcion(o)" alt="Imagen de {{ o.nombreOpcion }}" />
          </div>
          <div class="opcion-texto">
            <div class="opcion-header">
              <h5>{{ o.nombreOpcion }}</h5>
              <span class="precio">S/ {{ o.precio | number: '1.2-2' }}</span>
            </div>
            <p class="texto-sutil">{{ o.descripcion || 'Sin descripción' }}</p>
            <div class="detalle">
              <span *ngIf="o.stock != null">Stock: {{ o.stock }}</span>
              <span *ngIf="o.duracionMinutos">Duración: {{ o.duracionMinutos }} min</span>
            </div>
            <div class="opcion-agenda" *ngIf="seleccion[o.idOpcion]">
              <div class="campo-fecha">
                <label>Cantidad</label>
                <input
                  type="number"
                  min="1"
                  [max]="o.stock || null"
                  [ngModel]="cantidadesPorOpcion[o.idOpcion] || 1"
                  (ngModelChange)="actualizarCantidad(o, $event)"
                />
              </div>
              <div class="campo-fecha">
                <label>Fecha</label>
                <input
                  type="date"
                  [ngModel]="fechasPorOpcion[o.idOpcion]"
                  (ngModelChange)="actualizarFechaOpcion(o, $event)"
                  [min]="hoy | date: 'yyyy-MM-dd'"
                />
              </div>
              <div class="campo-fecha">
                <label>Hora</label>
                <input
                  type="time"
                  [ngModel]="horasPorOpcion[o.idOpcion]"
                  (ngModelChange)="actualizarHoraOpcion(o, $event)"
                  min="00:00"
                  max="23:59"
                />
              </div>
            </div>
          </div>
        </label>
      </div>

      <div class="estado" *ngIf="!opciones.length">Este proveedor aún no tiene opciones activas.</div>

      <div class="resumen-opciones" *ngIf="opciones.length">
        <div>
          <p class="texto-sutil">Seleccionados ({{ opcionesSeleccionadas.length }}/{{ opciones.length }})</p>
          <h4>S/ {{ totalSeleccionado | number: '1.2-2' }}</h4>
        </div>
        <div class="chips compactas" *ngIf="tieneSeleccion">
          <span class="chip" *ngFor="let op of opcionesSeleccionadas">
            {{ op.nombreOpcion }} (x{{ cantidadesPorOpcion[op.idOpcion] || 1 }})
          </span>
        </div>
      </div>

      <div class="agendar" *ngIf="opciones.length">
        <label>¿Para qué fecha lo deseas?</label>
        <div class="calendario-con-hora">
          <div class="calendario">
            <div class="calendario-header">
              <button class="btn-sutil" (click)="cambiarMes(-1)">&#8249;</button>
              <strong>{{ mesActual | date: 'LLLL yyyy' }}</strong>
              <button class="btn-sutil" (click)="cambiarMes(1)">&#8250;</button>
            </div>
            <div class="calendario-grid">
              <div
                class="dia"
                *ngFor="let d of diasCalendario"
                [ngClass]="{
                  confirmada: d.estado === 'confirmada',
                  pendiente: d.estado === 'pendiente',
                  rechazada: d.estado === 'rechazada',
                  activo: fechaEvento === d.fecha,
                  deshabilitado: d.pasado
                }"
                (click)="!d.pasado && seleccionarDia(d.fecha)"
              >
                {{ d.numero }}
              </div>
            </div>
            <div class="leyenda">
              <span class="punto confirmada"></span> Reservada
              <span class="punto pendiente"></span> Pendiente
              <span class="punto rechazada"></span> Rechazada
            </div>
          </div>

          <div class="selector-hora">
            <label for="horaServicio">Hora y minutos</label>
            <input
              id="horaServicio"
              type="time"
              [(ngModel)]="horaEvento"
              (ngModelChange)="actualizarHoraGeneral($event)"
              min="00:00"
              max="23:59"
            />
            <p class="texto-sutil" *ngIf="fechaEvento">
              Elegiste {{ fechaEvento | date: 'fullDate' }} a las {{ horaEvento }}.
            </p>
          </div>
        </div>
        <div class="acciones">
          <p class="texto-sutil info-agendar" *ngIf="mensajeAgendar">{{ mensajeAgendar }}</p>
          <div class="botones">
            <button class="btn-secundario" (click)="cerrarModal()">Cerrar</button>
            <button class="btn-primario" [disabled]="!fechaEvento || !tieneSeleccion || agendando" (click)="agendarEvento()">
              {{ agendando ? 'Agregando...' : 'Agregar servicio' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
