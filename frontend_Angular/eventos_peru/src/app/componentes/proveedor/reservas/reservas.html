<div class="card">
  <div class="titulo-card">
    <i class="bi bi-calendar-check text-success"></i>
    Reservas del proveedor
  </div>
  <p class="texto-suave">
    Controla tus reservas, revisa el detalle y confirma o rechaza cada solicitud.
  </p>

  <div class="estado" *ngIf="cargando">Cargando reservas...</div>
  <div class="estado error" *ngIf="error">{{ error }}</div>

    <table class="tabla" *ngIf="reservas.length">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Evento</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let r of reservas">
          <tr>
            <td>{{ r.fechaEvento | date }}</td>
            <td>{{ r.cliente?.nombre }}</td>
            <td>{{ nombreEvento(r) }}</td>
            <td><span [class]="estadoClase(r.estado)">{{ r.estado }}</span></td>
            <td class="acciones">
            <button class="btn-icono" (click)="verDetalle(r)" title="Ver detalle">
              <i class="bi bi-eye"></i>
            </button>
            <button
              class="btn-accion"
              (click)="abrirModalAccion(r, 'CONFIRMAR')"
              [disabled]="r.estado !== 'PENDIENTE'"
            >
              Confirmar
            </button>
            <button
              class="btn-accion rechazo"
              (click)="abrirModalAccion(r, 'RECHAZAR')"
              [disabled]="r.estado === 'CANCELADA'"
            >
              Rechazar
            </button>
          </td>
        </tr>
        <tr *ngIf="seleccionada?.idReserva === r.idReserva" class="fila-detalle">
          <td colspan="5">
            <div class="encabezado-detalle">
              <div>
                <p class="texto-suave">Cliente</p>
                <strong>{{ r.cliente?.nombre }}</strong>
                <small class="texto-suave" *ngIf="r.cliente?.celular">{{ r.cliente?.celular }}</small>
              </div>
              <div>
                <p class="texto-suave">Evento</p>
                <strong>{{ nombreEvento(r) }}</strong>
              </div>
              <div>
                <p class="texto-suave">Fecha</p>
                <strong>{{ r.fechaEvento | date: 'dd/MM/yyyy' }}</strong>
              </div>
              <div class="total-linea">
                <p class="texto-suave">Total estimado</p>
                <strong>S/ {{ totalReserva(r.idReserva) | number: '1.2-2' }}</strong>
              </div>
            </div>

            <div class="detalle-contenedor" *ngIf="detalles[r.idReserva]?.length; else cargandoDetalle">
              <div class="detalle-resumen">
                <p class="texto-suave">Servicios reservados</p>
                <ul>
                  <li *ngFor="let linea of resumenVinetas">{{ linea }}</li>
                </ul>
              </div>
              <div class="detalle-lista">
                <div class="detalle-card" *ngFor="let d of detalles[r.idReserva]">
                  <div>
                    <p class="chip">{{ d.nombreServicio || d.servicio?.nombre }}</p>
                    <p class="titulo-linea">{{ d.nombreOpcion || d.servicio?.descripcion || 'Opción seleccionada' }}</p>
                    <p class="texto-suave">Cantidad: {{ d.cantidad }}</p>
                  </div>
                  <div class="precio-linea">
                    <span>S/ {{ (d.precioUnitario || d.subtotal) | number: '1.2-2' }}</span>
                    <small class="texto-suave">Subtotal: S/ {{ subtotalDetalle(d) | number: '1.2-2' }}</small>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #cargandoDetalle>
              <p class="texto-suave">
                {{ detalleCargando[r.idReserva] ? 'Cargando detalle...' : 'Sin servicios registrados.' }}
              </p>
            </ng-template>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div class="estado" *ngIf="!reservas.length && !cargando">No tienes reservas registradas.</div>
</div>

<div class="modal-backdrop" *ngIf="mostrarModal" (click)="cerrarModal()"></div>
<div class="modal" *ngIf="mostrarModal">
  <div class="modal-contenido">
    <div class="modal-header">
      <div>
        <p class="texto-suave">{{ tipoAccion === 'CONFIRMAR' ? 'Confirmar reserva' : 'Rechazar reserva' }}</p>
        <h4>{{ seleccionada?.cliente?.nombre }}</h4>
        <p class="texto-suave">Evento: {{ seleccionada?.fechaEvento | date }}</p>
      </div>
      <button class="btn-secundario" (click)="cerrarModal()">Cerrar</button>
    </div>

    <div class="modal-body" *ngIf="seleccionada">
      <p class="texto-suave" *ngIf="tipoAccion === 'CONFIRMAR'">
        Revisa el mensaje y el detalle que enviaremos al cliente al confirmar la reserva.
      </p>
      <p class="texto-suave" *ngIf="tipoAccion === 'RECHAZAR'">
        Escribe el motivo del rechazo para que el cliente pueda revisar alternativas.
      </p>

        <div class="detalle-modal" *ngIf="detalles[seleccionada.idReserva]?.length; else sinDetalle">
          <div class="resumen-evento">
            <div>
              <p class="texto-suave">Evento</p>
              <strong>{{ nombreEvento(seleccionada) }}</strong>
            </div>
            <div>
              <p class="texto-suave">Cliente</p>
              <strong>{{ seleccionada.cliente?.nombre }}</strong>
              <small class="texto-suave" *ngIf="seleccionada.cliente?.celular">{{ seleccionada.cliente?.celular }}</small>
            </div>
            <div>
              <p class="texto-suave">Fecha</p>
              <strong>{{ seleccionada.fechaEvento | date: 'dd/MM/yyyy' }}</strong>
            </div>
            <div>
              <p class="texto-suave">Total estimado</p>
              <strong>S/ {{ totalReserva(seleccionada.idReserva) | number: '1.2-2' }}</strong>
            </div>
          </div>

          <div class="detalle-resumen">
            <p class="texto-suave">Servicios y opciones</p>
            <ul *ngIf="resumenVinetas.length; else sinVinetas">
              <li *ngFor="let linea of resumenVinetas">{{ linea }}</li>
            </ul>
            <ng-template #sinVinetas>
              <p class="texto-suave">Estamos cargando el detalle de los servicios...</p>
            </ng-template>
          </div>

          <div class="detalle-item" *ngFor="let d of detalles[seleccionada.idReserva]">
            <div>
              <p class="chip">{{ d.nombreServicio || d.servicio?.nombre }}</p>
              <p class="texto-suave">{{ d.nombreOpcion || d.servicio?.descripcion || 'Opción seleccionada' }}</p>
              <p class="texto-suave">Cantidad: {{ d.cantidad }}</p>
            </div>
            <div class="alineado">
              <span class="monto">S/ {{ (d.precioUnitario || d.subtotal) | number: '1.2-2' }}</span>
              <small class="texto-suave">Subtotal: S/ {{ subtotalDetalle(d) | number: '1.2-2' }}</small>
            </div>
          </div>

          <div class="total-modal">
            <span>Monto total</span>
            <strong>S/ {{ totalReserva(seleccionada.idReserva) | number: '1.2-2' }}</strong>
          </div>

          <div class="bloque-correo" *ngIf="tipoAccion === 'CONFIRMAR'">
            <p class="texto-suave">Vista previa del cuerpo del correo</p>
            <pre class="cuerpo-previo">{{ cuerpoMensaje }}</pre>
          </div>
        </div>
      <ng-template #sinDetalle>
        <p class="texto-suave">Aún no hay detalle de servicios para esta reserva.</p>
      </ng-template>

      <div class="campo-texto">
        <label for="asunto">Asunto</label>
        <input id="asunto" type="text" [(ngModel)]="asuntoMensaje" [readonly]="tipoAccion === 'CONFIRMAR'" />
      </div>

      <div class="campo-texto" *ngIf="tipoAccion === 'CONFIRMAR'">
        <label for="mensajeConfirmacion">Mensaje</label>
        <textarea
          id="mensajeConfirmacion"
          rows="4"
          [(ngModel)]="cuerpoMensaje"
          placeholder="Mensaje que acompañará la confirmación"
        ></textarea>
      </div>

      <div class="campo-texto" *ngIf="tipoAccion === 'RECHAZAR'">
        <label for="motivo">Motivo del rechazo</label>
        <textarea
          id="motivo"
          rows="4"
          [(ngModel)]="motivoRechazo"
          placeholder="Describe brevemente por qué no puedes aceptar la reserva"
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secundario" (click)="cerrarModal()">Cancelar</button>
      <button class="btn-accion" *ngIf="tipoAccion === 'CONFIRMAR'" (click)="confirmarSeleccionada()">
        Confirmar y notificar
      </button>
      <button class="btn-accion rechazo" *ngIf="tipoAccion === 'RECHAZAR'" (click)="rechazarSeleccionada()">
        Rechazar
      </button>
    </div>
  </div>
</div>
