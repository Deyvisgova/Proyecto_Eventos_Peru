<div class="card">
  <div class="titulo-card">
    <i class="bi bi-calendar-check text-success"></i>
    Reservas del proveedor
  </div>
  <p class="texto-suave">
    Controla tus reservas, revisa el detalle y confirma o rechaza cada solicitud.
  </p>

  <div class="estado" *ngIf="cargando">Cargando reservas...</div>
  <div class="estado error" *ngIf="error">{{ error }}</div>

  <table class="tabla" *ngIf="reservas.length">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let r of reservas">
        <tr>
          <td>{{ r.fechaEvento | date }}</td>
          <td>{{ r.cliente?.nombre }}</td>
          <td><span [class]="estadoClase(r.estado)">{{ r.estado }}</span></td>
          <td class="acciones">
            <button class="btn-icono" (click)="verDetalle(r)" title="Ver detalle">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn-accion" (click)="abrirModal(r, 'confirmar')" [disabled]="r.estado !== 'PENDIENTE'">
              Confirmar
            </button>
            <button class="btn-accion rechazo" (click)="abrirModal(r, 'cancelar')" [disabled]="r.estado === 'CANCELADA'">
              Cancelar
            </button>
          </td>
        </tr>
        <tr class="detalle-row" *ngIf="detalleAbierto === r.idReserva">
          <td colspan="4">
            <div class="acordeon">
              <div class="info-grid">
                <div>
                  <p class="label">Cliente</p>
                  <p class="valor">{{ r.cliente?.nombre || 'Sin nombre' }}</p>
                </div>
                <div>
                  <p class="label">Celular</p>
                  <p class="valor">{{ r.cliente?.celular || 'Sin teléfono' }}</p>
                </div>
                <div>
                  <p class="label">Fecha del evento</p>
                  <p class="valor">{{ r.fechaEvento | date: 'fullDate' }}</p>
                </div>
                <div>
                  <p class="label">Estado</p>
                  <span [class]="estadoClase(r.estado)">{{ r.estado }}</span>
                </div>
              </div>

              <div class="detalles-acordeon" *ngIf="detalles[r.idReserva]?.length; else sinDetalles">
                <h5>Servicios y opciones solicitadas</h5>
                <ul>
                  <li *ngFor="let d of detalles[r.idReserva]">
                    <div>
                      <strong>{{ d.opcion?.nombreOpcion || 'Servicio reservado' }}</strong>
                      <p class="texto-suave" *ngIf="d.opcion?.proveedorServicio?.catalogoServicio?.evento as evento; else eventoPendiente">
                        Evento: {{ evento.nombreEvento }}
                      </p>
                      <ng-template #eventoPendiente>
                        <p class="texto-suave">Evento: Pendiente</p>
                      </ng-template>
                    </div>
                    <div class="resumen-servicio">
                      <span>Opción/Servicio</span>
                      <strong>{{ d.cantidad }} x S/ {{ d.precioUnitario | number: '1.2-2' }}</strong>
                    </div>
                  </li>
                </ul>
              </div>
              <ng-template #sinDetalles>
                <p class="texto-suave">Aún no hay detalle de servicios registrado para esta reserva.</p>
              </ng-template>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div class="estado" *ngIf="!reservas.length && !cargando">No tienes reservas registradas.</div>
</div>

<div class="modal-backdrop" *ngIf="modalVisible" (click)="cerrarModal()"></div>
<div class="modal accion-modal" *ngIf="modalVisible">
  <div class="modal-header">
    <div>
      <p class="texto-suave">{{ modoAccion === 'confirmar' ? 'Confirmar' : 'Cancelar' }} reserva</p>
      <h4>{{ reservaEnAccion?.cliente?.nombre || 'Reserva seleccionada' }}</h4>
    </div>
    <button class="btn-icono" (click)="cerrarModal()"><i class="bi bi-x"></i></button>
  </div>

  <div class="modal-body">
    <p class="texto-suave">
      Previsualiza o edita el cuerpo del correo antes de {{ modoAccion === 'confirmar' ? 'confirmar' : 'cancelar' }} la reserva.
    </p>
    <label class="label">Cuerpo del correo</label>
    <textarea [(ngModel)]="cuerpoCorreo" rows="8" placeholder="Escribe aquí el mensaje a enviar..."></textarea>
  </div>

  <div class="modal-footer">
    <button class="btn-accion rechazo" (click)="cerrarModal()">Cerrar</button>
    <button class="btn-accion" (click)="ejecutarAccion()">
      {{ modoAccion === 'confirmar' ? 'Enviar y confirmar' : 'Enviar y cancelar' }}
    </button>
  </div>
</div>
