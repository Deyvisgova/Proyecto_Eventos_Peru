<section class="catalogo-proveedor">
  <header class="encabezado">
    <div>
      <h2>Gestiona tus servicios</h2>
      <p>Datos reales cargados desde tu cuenta de proveedor.</p>
    </div>
    <button type="button" class="btn-recargar" (click)="cargarCatalogo(); cargarOfertas(); cargarPropuestas()">
      <i class="bi bi-arrow-repeat"></i>
      Refrescar
    </button>
  </header>

  <div class="alerta" *ngIf="error">{{ error }}</div>
  <div class="exito" *ngIf="mensaje">{{ mensaje }}</div>
  <div class="alerta" *ngIf="!idProveedor && !cargandoProveedor">No se pudo identificar tu perfil de proveedor.</div>
  <div class="exito" *ngIf="cargandoProveedor">Cargando datos de tu cuenta de proveedor...</div>

  <div class="paneles">
    <div class="panel">
      <div class="panel-cabecera">
        <h3>Registrar nueva oferta</h3>
        <small>Vinculada al catálogo activo</small>
      </div>
      <form class="formulario" (ngSubmit)="registrarOferta()">
        <label>
          Tipo de servicio
          <select
            [(ngModel)]="nuevaOferta.idCatalogo"
            name="idCatalogo"
            [disabled]="!catalogoActivo.length || !idProveedor"
          >
            <option *ngFor="let cat of catalogoActivo" [value]="cat.idCatalogo">{{ cat.nombre }}</option>
          </select>
        </label>
        <label>
          Nombre público
          <input
            type="text"
            [(ngModel)]="nuevaOferta.nombrePublico"
            name="nombrePublico"
            placeholder="Ej. Paquete premium de decoración"
            [disabled]="!idProveedor"
          />
        </label>
        <label>
          Descripción general
          <textarea
            rows="3"
            [(ngModel)]="nuevaOferta.descripcionGeneral"
            name="descripcionGeneral"
            placeholder="Incluye lo que mejor describe tu servicio"
            [disabled]="!idProveedor"
          ></textarea>
        </label>
        <button class="btn-primario" type="submit" [disabled]="!idProveedor">Publicar oferta</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-cabecera">
        <h3>Proponer nuevo servicio</h3>
        <small>Si el catálogo no tiene lo que necesitas</small>
      </div>
      <form class="formulario" (ngSubmit)="proponerServicio()">
        <label>
          Nombre del servicio
          <input
            type="text"
            name="nombreTipo"
            [(ngModel)]="nuevoTipoProveedor.nombre"
            placeholder="Ej. Fotocabina"
            [disabled]="!idProveedor"
          />
        </label>
        <label>
          Descripción / nota para el admin
          <textarea
            rows="3"
            [(ngModel)]="nuevoTipoProveedor.descripcion"
            name="descripcionTipo"
            [disabled]="!idProveedor"
          ></textarea>
        </label>
        <div class="grupo-eventos">
          <p>Eventos aplicables</p>
          <div class="lista-check">
            <label class="check" *ngFor="let ev of eventos">
              <input
                type="checkbox"
                [checked]="ev.idEvento != null && eventosSeleccionadosPropuesta.has(ev.idEvento)"
                (change)="toggleEvento(ev.idEvento, eventosSeleccionadosPropuesta)"
                [disabled]="!idProveedor"
              />
              <span>{{ ev.nombreEvento }}</span>
            </label>
            <label class="check">
              <input
                type="checkbox"
                [checked]="eventos.length > 0 && eventosSeleccionadosPropuesta.size === eventos.length"
                (change)="seleccionarTodosEventos()"
                [disabled]="!idProveedor"
              />
              <span>Todos</span>
            </label>
          </div>
        </div>
        <button class="btn-primario" type="submit" [disabled]="!idProveedor">Enviar propuesta</button>
      </form>
    </div>

  </div>

  <div class="panel listado">
    <div class="panel-cabecera">
      <div>
        <h3>Servicios publicados</h3>
        <small>Editar o eliminar con dos acciones claras</small>
      </div>
      <button class="btn-secundario" type="button" (click)="cargarOfertas()">Actualizar</button>
    </div>

    <div *ngIf="cargandoOfertas" class="estado">Cargando tus servicios...</div>
    <div *ngIf="!cargandoOfertas && !ofertas.length" class="estado">Aún no registras servicios.</div>

    <div class="grid-servicios">
      <article class="tarjeta-servicio" *ngFor="let oferta of ofertas">
        <div class="servicio-marca">
          <span>{{ oferta.nombrePublico.charAt(0) || 'S' }}</span>
        </div>
        <div class="servicio-info">
          <div class="servicio-head">
            <p class="etiqueta">{{ oferta.catalogoServicio.nombre }}</p>
            <span class="badge" [ngClass]="oferta.estado === 'ACTIVO' ? 'badge-exito' : 'badge-aviso'">
              {{ oferta.estado }}
            </span>
          </div>
          <h4>{{ oferta.nombrePublico }}</h4>
          <p class="descripcion" *ngIf="oferta.descripcionGeneral">{{ oferta.descripcionGeneral }}</p>
          <div class="chips">
            <span class="chip" *ngIf="oferta.catalogoServicio.evento?.nombreEvento">
              Evento: {{ oferta.catalogoServicio.evento?.nombreEvento }}
            </span>
            <span class="chip" *ngIf="opcionesPorServicio[oferta.idProveedorServicio]?.length">
              {{ opcionesPorServicio[oferta.idProveedorServicio].length }} variantes
            </span>
          </div>
        </div>
        <div class="acciones-card">
          <button class="btn-primario" type="button" (click)="abrirModalServicio(oferta)">Editar</button>
          <button class="btn-secundario" type="button" (click)="abrirModalOpciones(oferta)">Variantes</button>
          <button class="btn-eliminar" type="button" (click)="eliminarOferta(oferta)">Eliminar</button>
        </div>
      </article>
    </div>
  </div>

  <div class="panel listado">
    <div class="panel-cabecera">
      <div>
        <h3>Mis propuestas de servicios</h3>
        <small>Revisa el estado y corrige si fueron rechazadas</small>
      </div>
      <button class="btn-secundario" type="button" (click)="cargarPropuestas()">Actualizar</button>
    </div>

    <div *ngIf="cargandoPropuestas" class="estado">Cargando propuestas...</div>
    <div *ngIf="!cargandoPropuestas && !propuestas.length" class="estado">No has enviado propuestas aún.</div>

    <div class="tarjeta-servicio" *ngFor="let p of propuestas">
      <header class="cabecera-servicio">
        <div>
          <p class="etiqueta">{{ p.creadoPor }}</p>
          <h4>{{ p.nombre }}</h4>
          <p class="descripcion" *ngIf="p.descripcion">{{ p.descripcion }}</p>
          <p class="motivo" *ngIf="p.motivoRechazo">Motivo de rechazo: {{ p.motivoRechazo }}</p>
        </div>
        <span class="badge" [ngClass]="p.estado === 'ACTIVO' ? 'badge-exito' : p.estado === 'RECHAZADO' ? 'badge-error' : 'badge-aviso'">
          {{ p.estado }}
        </span>
      </header>

      <div class="formulario" *ngIf="p.estado === 'RECHAZADO'">
        <label>
          Nombre del servicio
          <input
            type="text"
            [(ngModel)]="propuestasEdicion[p.idCatalogo].nombre"
            name="edit-propuesta-nombre-{{ p.idCatalogo }}"
          />
        </label>
        <label>
          Descripción
          <textarea
            rows="2"
            [(ngModel)]="propuestasEdicion[p.idCatalogo].descripcion"
            name="edit-propuesta-descripcion-{{ p.idCatalogo }}"
          ></textarea>
        </label>
        <button class="btn-primario" type="button" (click)="reenviarPropuesta(p)">
          Actualizar y reenviar a revisión
        </button>
      </div>
    </div>
  </div>

  <!-- Modal edición de servicio -->
  <div class="modal" *ngIf="servicioEnModal">
    <div class="modal-contenido">
      <header>
        <h3>Editar servicio</h3>
        <button class="cerrar" type="button" (click)="cerrarModalServicio()">×</button>
      </header>
      <div class="formulario">
        <label>
          Tipo de servicio
          <select [(ngModel)]="edicionOferta[servicioEnModal.idProveedorServicio].idCatalogo" name="edit-cat">
            <option *ngFor="let cat of catalogoActivo" [value]="cat.idCatalogo">{{ cat.nombre }}</option>
          </select>
        </label>
        <label>
          Nombre público
          <input
            type="text"
            [(ngModel)]="edicionOferta[servicioEnModal.idProveedorServicio].nombrePublico"
            name="edit-nombre"
          />
        </label>
        <label>
          Descripción general
          <textarea
            rows="2"
            [(ngModel)]="edicionOferta[servicioEnModal.idProveedorServicio].descripcionGeneral"
            name="edit-descripcion"
          ></textarea>
        </label>
        <div class="acciones-modal">
          <button class="btn-primario" type="button" (click)="guardarCambiosServicio()">Guardar</button>
          <button class="btn-secundario" type="button" (click)="abrirModalOpciones(servicioEnModal)">
            Gestionar variantes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de opciones/variantes -->
  <div class="modal" *ngIf="opcionesEnModal">
    <div class="modal-contenido opciones">
      <header>
        <h3>Opciones para {{ opcionesEnModal.nombrePublico }}</h3>
        <button class="cerrar" type="button" (click)="cerrarModalOpciones()">×</button>
      </header>

      <div class="opcion-formulario ampliado">
        <input
          type="text"
          placeholder="Nombre de la opción"
          [(ngModel)]="nuevaOpcion[opcionesEnModal.idProveedorServicio].nombreOpcion"
          name="nombreOpcion-{{ opcionesEnModal.idProveedorServicio }}"
        />
        <input
          type="text"
          placeholder="Descripción"
          [(ngModel)]="nuevaOpcion[opcionesEnModal.idProveedorServicio].descripcion"
          name="descripcion-{{ opcionesEnModal.idProveedorServicio }}"
        />
        <input
          type="number"
          step="0.01"
          placeholder="Precio"
          [(ngModel)]="nuevaOpcion[opcionesEnModal.idProveedorServicio].precio"
          name="precio-{{ opcionesEnModal.idProveedorServicio }}"
        />
        <input
          type="number"
          placeholder="Duración (min)"
          [(ngModel)]="nuevaOpcion[opcionesEnModal.idProveedorServicio].duracionMinutos"
          name="duracion-{{ opcionesEnModal.idProveedorServicio }}"
        />
        <input
          type="number"
          placeholder="Stock"
          [(ngModel)]="nuevaOpcion[opcionesEnModal.idProveedorServicio].stock"
          name="stock-{{ opcionesEnModal.idProveedorServicio }}"
        />
        <label class="input-file">
          <input
            type="file"
            accept="image/*"
            (change)="seleccionarArchivo($event, 'opciones', { tipo: 'opcion-nueva', id: opcionesEnModal.idProveedorServicio })"
          />
          <span>
            {{ nombresArchivo['opcion-nueva-' + opcionesEnModal.idProveedorServicio] || 'Seleccionar imagen' }}
          </span>
        </label>
        <div class="opcion-preview" *ngIf="nuevaOpcion[opcionesEnModal.idProveedorServicio]?.urlFoto">
          <img [src]="obtenerVistaOpcion(nuevaOpcion[opcionesEnModal.idProveedorServicio].urlFoto)" alt="Vista previa" />
          <small>{{ nuevaOpcion[opcionesEnModal.idProveedorServicio].urlFoto }}</small>
        </div>
        <button class="btn-primario" type="button" (click)="agregarOpcion(opcionesEnModal)">Agregar opción</button>
      </div>

      <div class="lista-opciones" *ngIf="opcionesPorServicio[opcionesEnModal.idProveedorServicio]?.length">
        <div class="opcion" *ngFor="let op of opcionesPorServicio[opcionesEnModal.idProveedorServicio]">
          <div class="opcion-media">
            <img [src]="obtenerVistaOpcion(edicionOpcion[op.idOpcion]?.urlFoto || op.urlFoto)" alt="Imagen de opción" />
            <small>{{ edicionOpcion[op.idOpcion]?.urlFoto || op.urlFoto || 'Sin imagen subida' }}</small>
          </div>
          <div class="opcion-info">
            <div class="opcion-header">
              <p class="nombre">{{ op.nombreOpcion }}</p>
              <span class="badge" [ngClass]="op.estado === 'ACTIVO' ? 'badge-exito' : 'badge-error'">
                {{ op.estado }}
              </span>
            </div>
            <p class="descripcion" *ngIf="op.descripcion">{{ op.descripcion }}</p>
            <div class="opcion-datos">
              <span>Precio: S/ {{ op.precio }}</span>
              <span *ngIf="op.duracionMinutos">Duración: {{ op.duracionMinutos }} min</span>
              <span *ngIf="op.stock">Stock: {{ op.stock }}</span>
            </div>
            <div class="formulario opcion-edicion">
              <label>Nombre<input type="text" [(ngModel)]="edicionOpcion[op.idOpcion].nombreOpcion" name="edit-nombre-op-{{ op.idOpcion }}" /></label>
              <label>Descripción<input type="text" [(ngModel)]="edicionOpcion[op.idOpcion].descripcion" name="edit-descripcion-op-{{ op.idOpcion }}" /></label>
              <label>Precio<input type="number" step="0.01" [(ngModel)]="edicionOpcion[op.idOpcion].precio" name="edit-precio-op-{{ op.idOpcion }}" /></label>
              <label>Duración (min)<input type="number" [(ngModel)]="edicionOpcion[op.idOpcion].duracionMinutos" name="edit-duracion-op-{{ op.idOpcion }}" /></label>
              <label>Stock<input type="number" [(ngModel)]="edicionOpcion[op.idOpcion].stock" name="edit-stock-op-{{ op.idOpcion }}" /></label>
              <label class="archivo-opcion input-file">
                <input
                  type="file"
                  accept="image/*"
                  (change)="seleccionarArchivo($event, 'opciones', { tipo: 'opcion-edicion', id: op.idOpcion })"
                />
                <span>
                  {{ nombresArchivo['opcion-edicion-' + op.idOpcion] || 'Seleccionar nueva imagen' }}
                </span>
              </label>
              <div class="opcion-botones">
                <button
                  class="btn-secundario"
                  type="button"
                  (click)="cambiarEstadoOpcion(op, op.estado === 'ACTIVO' ? 'NO_DISPONIBLE' : 'ACTIVO')"
                >
                  {{ op.estado === 'ACTIVO' ? 'Marcar no disponible' : 'Activar' }}
                </button>
                <button class="btn-primario" type="button" (click)="actualizarOpcion(op)">Actualizar</button>
                <button class="btn-secundario" type="button" (click)="eliminarOpcion(op)">Eliminar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <p *ngIf="!opcionesPorServicio[opcionesEnModal.idProveedorServicio]?.length" class="texto-suave">
        Aún no agregas opciones para esta oferta.
      </p>
    </div>
  </div>
</section>
