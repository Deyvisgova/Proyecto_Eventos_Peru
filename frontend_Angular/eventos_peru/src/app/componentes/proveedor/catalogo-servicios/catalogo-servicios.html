<section class="catalogo-proveedor">
  <header class="encabezado">
    <div>
      <h2>Gestiona tus servicios</h2>
      <p>
        Elige un tipo del catálogo, registra tu oferta y agrega opciones con precios y cobertura. Si falta un
        tipo, envía tu propuesta.
      </p>
    </div>
    <button type="button" class="btn-recargar" (click)="cargarCatalogo(); cargarOfertas(); cargarPropuestas()">
      <i class="bi bi-arrow-repeat"></i>
      Refrescar
    </button>
  </header>

  <div class="alerta" *ngIf="error">{{ error }}</div>
  <div class="exito" *ngIf="mensaje">{{ mensaje }}</div>
  <div class="alerta" *ngIf="!idProveedor && !cargandoProveedor">No se pudo identificar tu perfil de proveedor.</div>
  <div class="exito" *ngIf="cargandoProveedor">Cargando datos de tu cuenta de proveedor...</div>

  <div class="paneles">
    <div class="panel">
      <div class="panel-cabecera">
        <h3>Registrar nueva oferta</h3>
        <small>Se vincula al catálogo activo.</small>
      </div>
      <form class="formulario" (ngSubmit)="registrarOferta()">
        <label>
          Tipo de servicio
          <select
            [(ngModel)]="nuevaOferta.idCatalogo"
            name="idCatalogo"
            [disabled]="!catalogoActivo.length || !idProveedor"
          >
            <option *ngFor="let cat of catalogoActivo" [value]="cat.idCatalogo">{{ cat.nombre }}</option>
          </select>
        </label>
        <label>
          Nombre público
          <input
            type="text"
            [(ngModel)]="nuevaOferta.nombrePublico"
            name="nombrePublico"
            placeholder="Ej. Paquete premium de decoración"
            [disabled]="!idProveedor"
          />
        </label>
        <label>
          Descripción general
          <textarea
            rows="3"
            [(ngModel)]="nuevaOferta.descripcionGeneral"
            name="descripcionGeneral"
            placeholder="Incluye lo que mejor describe tu servicio"
            [disabled]="!idProveedor"
          ></textarea>
        </label>
        <label>
          URL de foto
          <input
            type="url"
            [(ngModel)]="nuevaOferta.urlFoto"
            name="urlFoto"
            placeholder="Ej. assets/servicios/foto.jpg"
            [disabled]="!idProveedor"
          />
        </label>
        <label class="subida-archivo">
          Subir foto a assets/servicios
          <input
            type="file"
            accept="image/*"
            (change)="seleccionarArchivo($event, 'servicios', { tipo: 'oferta-nueva' })"
            [disabled]="!idProveedor"
          />
          <small>El archivo se copiará dentro de assets/servicios y se colocará la ruta automáticamente.</small>
        </label>
        <button class="btn-primario" type="submit" [disabled]="!idProveedor">Publicar oferta</button>
      </form>
    </div>

    <div class="panel">
      <div class="panel-cabecera">
        <h3>Proponer nuevo tipo</h3>
        <small>Si el catálogo no tiene lo que necesitas.</small>
      </div>
      <form class="formulario" (ngSubmit)="proponerTipo()">
        <label>
          Nombre del tipo
          <input
            type="text"
            name="nombreTipo"
            [(ngModel)]="nuevoTipoProveedor.nombre"
            placeholder="Ej. Fotocabina"
            [disabled]="!idProveedor"
          />
        </label>
        <label>
          Descripción / nota para el admin
          <textarea
            rows="3"
            [(ngModel)]="nuevoTipoProveedor.descripcion"
            name="descripcionTipo"
            [disabled]="!idProveedor"
          ></textarea>
        </label>
        <button class="btn-secundario" type="submit" [disabled]="!idProveedor">Enviar propuesta</button>
      </form>
    </div>
  </div>

  <div class="panel listado">
    <div class="panel-cabecera">
      <div>
        <h3>Mis servicios</h3>
        <small>Activa, pausa, edita o detalla opciones</small>
      </div>
      <button class="btn-secundario" type="button" (click)="cargarOfertas()">Actualizar</button>
    </div>

    <div *ngIf="cargandoOfertas" class="estado">Cargando tus servicios...</div>
    <div *ngIf="!cargandoOfertas && !ofertas.length" class="estado">Aún no registras servicios.</div>

    <div class="tarjeta-servicio" *ngFor="let oferta of ofertas">
      <header class="cabecera-servicio">
        <div>
          <p class="etiqueta">{{ oferta.catalogoServicio.nombre }}</p>
          <h4>{{ oferta.nombrePublico }}</h4>
          <p class="descripcion" *ngIf="oferta.descripcionGeneral">{{ oferta.descripcionGeneral }}</p>
        </div>
        <div class="estado-servicio">
          <span class="badge" [ngClass]="oferta.estado === 'ACTIVO' ? 'badge-exito' : 'badge-aviso'">
            {{ oferta.estado }}
          </span>
          <div class="acciones">
            <button class="btn-secundario" type="button" (click)="cambiarEstado(oferta, 'PAUSADO')">
              Pausar
            </button>
            <button class="btn-primario" type="button" (click)="cambiarEstado(oferta, 'ACTIVO')">
              Activar
            </button>
            <button class="btn-secundario" type="button" (click)="eliminarOferta(oferta)">Eliminar</button>
          </div>
        </div>
      </header>

      <div class="formulario edicion-oferta">
        <label>
          Nombre público
          <input
            type="text"
            [(ngModel)]="edicionOferta[oferta.idProveedorServicio].nombrePublico"
            name="edit-nombre-{{ oferta.idProveedorServicio }}"
          />
        </label>
        <label>
          Descripción general
          <textarea
            rows="2"
            [(ngModel)]="edicionOferta[oferta.idProveedorServicio].descripcionGeneral"
            name="edit-descripcion-{{ oferta.idProveedorServicio }}"
          ></textarea>
        </label>
        <label>
          URL de foto
          <input
            type="url"
            [(ngModel)]="edicionOferta[oferta.idProveedorServicio].urlFoto"
            name="edit-foto-{{ oferta.idProveedorServicio }}"
            placeholder="Ej. assets/servicios/foto.jpg"
          />
        </label>
        <label class="subida-archivo">
          Subir foto a assets/servicios
          <input
            type="file"
            accept="image/*"
            (change)="seleccionarArchivo($event, 'servicios', { tipo: 'oferta-edicion', id: oferta.idProveedorServicio })"
          />
          <small>La ruta se actualizará al guardar el archivo.</small>
        </label>
        <button class="btn-primario" type="button" (click)="actualizarOferta(oferta)">Guardar cambios</button>
      </div>

      <div class="opciones">
        <div class="opciones-encabezado">
          <strong>Opciones/variantes</strong>
          <button class="btn-secundario" type="button" (click)="cargarOpciones(oferta)">
            Ver opciones
          </button>
        </div>

        <div class="opcion-formulario">
          <input
            type="text"
            placeholder="Nombre de la opción"
            [(ngModel)]="nuevaOpcion[oferta.idProveedorServicio].nombreOpcion"
            name="nombreOpcion-{{ oferta.idProveedorServicio }}"
          />
          <input
            type="number"
            step="0.01"
            placeholder="Precio"
            [(ngModel)]="nuevaOpcion[oferta.idProveedorServicio].precio"
            name="precio-{{ oferta.idProveedorServicio }}"
          />
          <input
            type="number"
            placeholder="Duración (min)"
            [(ngModel)]="nuevaOpcion[oferta.idProveedorServicio].duracionMinutos"
            name="duracion-{{ oferta.idProveedorServicio }}"
          />
          <input
            type="number"
            placeholder="Stock"
            [(ngModel)]="nuevaOpcion[oferta.idProveedorServicio].stock"
            name="stock-{{ oferta.idProveedorServicio }}"
          />
          <input
            type="url"
            placeholder="URL de foto"
            [(ngModel)]="nuevaOpcion[oferta.idProveedorServicio].urlFoto"
            name="foto-{{ oferta.idProveedorServicio }}"
          />
          <input
            type="file"
            accept="image/*"
            (change)="seleccionarArchivo($event, 'opciones', { tipo: 'opcion-nueva', id: oferta.idProveedorServicio })"
          />
          <button class="btn-primario" type="button" (click)="agregarOpcion(oferta)">Agregar opción</button>
        </div>

        <div class="lista-opciones" *ngIf="opcionesPorServicio[oferta.idProveedorServicio]?.length">
          <div class="opcion" *ngFor="let op of opcionesPorServicio[oferta.idProveedorServicio]">
            <div class="opcion-info">
              <p class="nombre">{{ op.nombreOpcion }}</p>
              <p class="descripcion" *ngIf="op.descripcion">{{ op.descripcion }}</p>
              <small>Precio: S/ {{ op.precio }}</small>
              <small *ngIf="op.urlFoto">Foto: {{ op.urlFoto }}</small>
            </div>
            <div class="estado-opcion">
              <span class="badge" [ngClass]="op.estado === 'ACTIVO' ? 'badge-exito' : 'badge-error'">
                {{ op.estado }}
              </span>
              <div class="formulario opcion-edicion">
                <input
                  type="text"
                  [(ngModel)]="edicionOpcion[op.idOpcion].nombreOpcion"
                  name="edit-nombre-op-{{ op.idOpcion }}"
                  placeholder="Nombre"
                />
                <input
                  type="number"
                  step="0.01"
                  [(ngModel)]="edicionOpcion[op.idOpcion].precio"
                  name="edit-precio-op-{{ op.idOpcion }}"
                  placeholder="Precio"
                />
                <input
                  type="url"
                  [(ngModel)]="edicionOpcion[op.idOpcion].urlFoto"
                  name="edit-foto-op-{{ op.idOpcion }}"
                  placeholder="Ej. assets/opciones/foto.jpg"
                />
                <input
                  type="file"
                  accept="image/*"
                  (change)="seleccionarArchivo($event, 'opciones', { tipo: 'opcion-edicion', id: op.idOpcion })"
                />
                <div class="opcion-botones">
                  <button
                    class="btn-secundario"
                    type="button"
                    (click)="cambiarEstadoOpcion(op, op.estado === 'ACTIVO' ? 'NO_DISPONIBLE' : 'ACTIVO')"
                  >
                    {{ op.estado === 'ACTIVO' ? 'Marcar no disponible' : 'Activar' }}
                  </button>
                  <button class="btn-primario" type="button" (click)="actualizarOpcion(op)">Actualizar</button>
                  <button class="btn-secundario" type="button" (click)="eliminarOpcion(op)">Eliminar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p *ngIf="!opcionesPorServicio[oferta.idProveedorServicio]?.length" class="texto-suave">
          Aún no agregas opciones para esta oferta.
        </p>
      </div>
    </div>
  </div>

  <div class="panel listado">
    <div class="panel-cabecera">
      <div>
        <h3>Mis propuestas de tipos de servicio</h3>
        <small>Revisa el estado y corrige si fueron rechazadas</small>
      </div>
      <button class="btn-secundario" type="button" (click)="cargarPropuestas()">Actualizar</button>
    </div>

    <div *ngIf="cargandoPropuestas" class="estado">Cargando propuestas...</div>
    <div *ngIf="!cargandoPropuestas && !propuestas.length" class="estado">No has enviado propuestas aún.</div>

    <div class="tarjeta-servicio" *ngFor="let p of propuestas">
      <header class="cabecera-servicio">
        <div>
          <p class="etiqueta">{{ p.creadoPor }}</p>
          <h4>{{ p.nombre }}</h4>
          <p class="descripcion" *ngIf="p.descripcion">{{ p.descripcion }}</p>
          <p class="motivo" *ngIf="p.motivoRechazo">Motivo de rechazo: {{ p.motivoRechazo }}</p>
        </div>
        <span class="badge" [ngClass]="p.estado === 'ACTIVO' ? 'badge-exito' : p.estado === 'RECHAZADO' ? 'badge-error' : 'badge-aviso'">
          {{ p.estado }}
        </span>
      </header>

      <div class="formulario" *ngIf="p.estado === 'RECHAZADO'">
        <label>
          Nombre del servicio
          <input
            type="text"
            [(ngModel)]="propuestasEdicion[p.idCatalogo].nombre"
            name="edit-propuesta-nombre-{{ p.idCatalogo }}"
          />
        </label>
        <label>
          Descripción
          <textarea
            rows="2"
            [(ngModel)]="propuestasEdicion[p.idCatalogo].descripcion"
            name="edit-propuesta-descripcion-{{ p.idCatalogo }}"
          ></textarea>
        </label>
        <button class="btn-primario" type="button" (click)="reenviarPropuesta(p)">
          Actualizar y reenviar a revisión
        </button>
      </div>
    </div>
  </div>
</section>
